<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AssetFlow CMMS Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* CSS remains unchanged as it was correct */
        :root {
            --color-bg: #f8f9fa;
            --color-sidebar-bg: #ffffff;
            --color-card-bg: #ffffff;
            --color-text-primary: #111827;
            --color-text-secondary: #4b5563;
            --color-text-muted: #6b7280;
            --color-border: #e5e7eb;
            --color-border-light: #f3f4f6;
            --color-icon: #6b7280;
            --color-nav-text: #374151;
            --color-nav-active-bg: #eff6ff;
            --color-nav-active-text: #2563eb;
            --color-nav-active-border: #3b82f6;
            --color-primary: #3b82f6;
            --color-primary-light: #eff6ff;
            --color-primary-dark: #2563eb;
            --color-red-bg: #fee2e2;
            --color-red-text: #b91c1c;
            --color-orange-bg: #ffedd5;
            --color-orange-text: #9a3412;
            --color-yellow-bg: #fef9c3;
            --color-yellow-text: #854d0e;
            --color-green-bg: #dcfce7;
            --color-green-text: #166534;
            --color-blue-bg: #dbeafe;
            --color-blue-text: #1e40af;
            --color-gray-bg: #f3f4f6;
            --color-gray-text: #374151;
            --color-purple-bg: #f3e8ff;
            --color-purple-text: #7e22ce;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.06), 0 2px 4px -2px rgb(0 0 0 / 0.06);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.08), 0 4px 6px -4px rgb(0 0 0 / 0.08);
            --border-radius: 0.75rem;
            --border-radius-lg: 0.5rem;
            --transition-speed: 0.3s;
        }

        body.dark-mode {
            --color-bg: #0d1117;
            --color-sidebar-bg: #161b22;
            --color-card-bg: #161b22;
            --color-text-primary: #f9fafb;
            --color-text-secondary: #d1d5db;
            --color-text-muted: #9ca3af;
            --color-border: #374151;
            --color-border-light: #374151;
            --color-icon: #9ca3af;
            --color-nav-text: #d1d5db;
            --color-nav-active-bg: #374151;
            --color-nav-active-text: #ffffff;
            --color-red-bg: #450a0a;
            --color-red-text: #fca5a5;
            --color-orange-bg: #4a2c0d;
            --color-orange-text: #fdba74;
            --color-yellow-bg: #423b0b;
            --color-yellow-text: #fde047;
            --color-green-bg: #0d3d20;
            --color-green-text: #86efac;
            --color-blue-bg: #1e2a56;
            --color-blue-text: #93c5fd;
            --color-gray-bg: #374151;
            --color-gray-text: #f3f4f6;
            --color-purple-bg: #3b0764;
            --color-purple-text: #d8b4fe;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-secondary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        button,
        input,
        textarea,
        select {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
            color: inherit;
        }

        button:focus,
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            color: var(--color-text-primary);
        }

        .loading-screen {
            position: fixed;
            inset: 0;
            background-color: var(--color-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            flex-direction: column;
            gap: 1rem;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .sign-in-screen {
            position: fixed;
            inset: 0;
            background-color: var(--color-bg);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99;
        }

        .sign-in-screen.active {
            display: flex;
        }

        .sign-in-card {
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius);
            padding: 3rem;
            box-shadow: var(--shadow-lg);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .google-sign-in-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: #4285f4;
            color: white;
            border-radius: var(--border-radius-lg);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: background-color 0.2s;
            margin-top: 1.5rem;
        }

        #app-container {
            display: none;
            flex-direction: row;
            min-height: 100vh;
        }

        #app-container.ready {
            display: flex;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100%;
            width: 256px;
            background-color: var(--color-sidebar-bg);
            border-right: 1px solid var(--color-border);
            box-shadow: var(--shadow-lg);
            transition: width var(--transition-speed) ease, height var(--transition-speed) ease;
            z-index: 40;
            display: flex;
            flex-direction: column;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar.collapsed .sidebar-header-text,
        .sidebar.collapsed .nav-text,
        .sidebar.collapsed .user-info {
            display: none;
        }

        .sidebar.collapsed .sidebar-header,
        .sidebar.collapsed .nav-button,
        .sidebar.collapsed .user-profile-container {
            justify-content: center;
        }

        .sidebar.collapsed .user-profile {
            background: none;
            padding: 0;
        }

        .sidebar.collapsed .user-avatar {
            margin: 0;
        }

        .sidebar-header {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid var(--color-border-light);
            flex-shrink: 0;
        }

        .sidebar-logo {
            flex-shrink: 0;
            width: 2.5rem;
            height: 2.5rem;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border-radius: var(--border-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-logo i {
            color: white;
        }

        .sidebar-header-text h1 {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .sidebar-header-text p {
            font-size: 0.875rem;
            color: var(--color-text-muted);
        }

        nav {
            margin-top: 1rem;
            flex-grow: 1;
            padding: 0 0.75rem;
            overflow-y: auto;
        }

        .nav-button {
            width: 100%;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius-lg);
            color: var(--color-nav-text);
            font-weight: 500;
            transition: all 0.2s ease;
            border-right: 3px solid transparent;
        }

        .nav-button i {
            margin-right: 1rem;
            color: var(--color-icon);
        }

        .nav-button:hover {
            background-color: var(--color-nav-active-bg);
            color: var(--color-nav-active-text);
        }

        .nav-button.active {
            background-color: var(--color-nav-active-bg);
            color: var(--color-nav-active-text);
            border-right-color: var(--color-nav-active-border);
        }

        .nav-button.active i,
        .nav-button:hover i {
            color: var(--color-nav-active-text);
        }

        .sidebar-footer {
            padding: 1rem 1.5rem;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 999px;
            background: linear-gradient(to right, #4f46e5, #7c3aed);
            width: 100%;
            justify-content: center;
        }

        .user-avatar {
            flex-shrink: 0;
            width: 2.5rem;
            height: 2.5rem;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4f46e5;
            font-size: 1rem;
            font-weight: 600;
            margin-right: 0.75rem;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info .user-name {
            font-weight: 600;
            color: white;
        }

        .user-info .user-role {
            font-size: 0.8rem;
            color: #ddd6fe;
        }

        .main-content {
            flex-grow: 1;
            margin-left: 256px;
            transition: margin-left var(--transition-speed) ease;
        }

        .main-content.sidebar-collapsed {
            margin-left: 80px;
        }

        header {
            background-color: var(--color-sidebar-bg);
            border-bottom: 1px solid var(--color-border);
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 30;
            height: 64px;
        }

        .header-left,
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        #app-container.layout-top .sidebar {
            width: 100%;
            height: 64px;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            border-right: none;
            padding: 0 1.5rem;
        }

        #app-container.layout-top .sidebar-header {
            padding: 0;
            border: none;
        }

        #app-container.layout-top nav {
            display: flex;
            flex-direction: row;
            align-items: center;
            flex-grow: 1;
            margin: 0;
            padding: 0 2rem;
            height: 100%;
            gap: 0.5rem;
        }

        #app-container.layout-top .nav-button {
            border-right: none;
            border-bottom: 3px solid transparent;
            border-radius: 0;
            height: 100%;
        }

        #app-container.layout-top .nav-button.active {
            background: none;
            border-bottom-color: var(--color-nav-active-border);
            color: var(--color-nav-active-text);
        }

        #app-container.layout-top .sidebar-footer {
            padding: 0;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 1rem;
        }

        #app-container.layout-top #user-profile-container {
            display: none;
        }

        #app-container.layout-top .main-content {
            margin-left: 0;
            margin-top: 64px;
        }

        #app-container.layout-top #main-header {
            display: none;
        }

        .icon-button {
            width: 2.5rem;
            height: 2.5rem;
            color: var(--color-icon);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s;
        }

        .icon-button:hover {
            background-color: var(--color-border-light);
            color: var(--color-text-primary);
        }

        .notification-dot {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 0.65rem;
            height: 0.65rem;
            background-color: #ef4444;
            border-radius: 50%;
            border: 2px solid var(--color-sidebar-bg);
            display: none;
        }

        .compact-user-profile {
            background: none;
            padding: 0.25rem;
            gap: 0.75rem;
            border: 1px solid transparent;
            border-radius: 999px;
            transition: all 0.2s;
            cursor: pointer;
            width: auto;
            display: flex;
            align-items: center;
        }

        .compact-user-profile:hover {
            background-color: var(--color-bg);
            border-color: var(--color-border);
        }

        .compact-user-profile .user-avatar {
            width: 2.25rem;
            height: 2.25rem;
            margin-right: 0;
            background-color: var(--color-primary-light);
            color: var(--color-primary-dark);
        }

        .compact-user-profile .user-info .user-name {
            color: var(--color-text-primary);
        }

        .compact-user-profile .user-info .user-role {
            display: none;
        }

        body.dark-mode .compact-user-profile .user-info .user-name {
            color: var(--color-text-primary);
        }

        #app-container.layout-top .compact-user-profile .user-info {
            display: block !important;
        }

        main {
            padding: 1.5rem;
        }

        .page-content-view {
            display: none;
        }

        .page-content-view.active {
            display: block;
        }

        .card {
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--color-border);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--color-border-light);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .card.clickable-card {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .card.clickable-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-title-lg {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border-radius: var(--border-radius-lg);
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-secondary {
            background-color: var(--color-card-bg);
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
        }

        .btn-danger {
            background-color: var(--color-red-bg);
            color: var(--color-red-text);
        }

        .btn-danger:hover {
            background-color: #fee2e2;
            border-color: #ef4444;
        }


        .tag {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-overdue,
        .priority-critical {
            background-color: var(--color-red-bg);
            color: var(--color-red-text);
        }

        .priority-high {
            background-color: var(--color-orange-bg);
            color: var(--color-orange-text);
        }

        .status-needs-attention,
        .priority-medium {
            background-color: var(--color-yellow-bg);
            color: var(--color-yellow-text);
        }

        .status-completed,
        .status-operational,
        .priority-low {
            background-color: var(--color-green-bg);
            color: var(--color-green-text);
        }

        .status-in-progress {
            background-color: var(--color-blue-bg);
            color: var(--color-blue-text);
        }

        .status-open {
            background-color: var(--color-gray-bg);
            color: var(--color-gray-text);
        }

        .status-suggested {
            background-color: var(--color-purple-bg);
            color: var(--color-purple-text);
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(4px);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius);
            max-width: 672px;
            width: 100%;
            max-height: 90vh;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close-btn {
            font-size: 1.5rem;
            line-height: 1;
            color: var(--color-icon);
        }

        .modal-body {
            padding: 1.5rem;
            flex-grow: 1;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--color-border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            background-color: var(--color-bg);
            flex-shrink: 0;
        }

        .modal-footer .btn-secondary {
            margin-right: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-lg);
            background: var(--color-bg);
            color: var(--color-text-primary);
            font-size: 1rem;
        }

        .image-preview-container {
            margin-bottom: 1.5rem;
        }

        #wo-image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: var(--border-radius-lg);
            object-fit: cover;
            border: 1px solid var(--color-border);
        }

        #wo-image-preview:not([src]),
        #wo-image-preview[src=""] {
            display: none;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--color-border-light);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--color-primary);
        }

        input:checked+.slider:before {
            transform: translateX(22px);
        }

        #notification-panel {
            position: fixed;
            display: none;
            z-index: 50;
            width: 380px;
            max-height: 450px;
            overflow-y: auto;
            right: 1.5rem;
            top: 70px;
        }

        .notification-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--color-border-light);
        }

        .view-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-left: auto;
        }

        .view-toggle {
            display: flex;
            align-items: center;
            background-color: var(--color-bg);
            border-radius: var(--border-radius-lg);
            padding: 4px;
        }

        .view-toggle button {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            line-height: 1;
            color: var(--color-icon);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .view-toggle button.active {
            background-color: var(--color-card-bg);
            color: var(--color-primary);
            box-shadow: var(--shadow-sm);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            text-align: left;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--color-border);
            vertical-align: middle;
        }

        .data-table th {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--color-text-muted);
        }

        .data-table tbody tr {
            cursor: pointer;
        }

        .data-table tbody tr:hover {
            background-color: var(--color-bg);
        }

        .user-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-radius: var(--border-radius-lg);
        }

        .user-list-item:nth-child(odd) {
            background-color: var(--color-bg);
        }

        .detailed-card-main {
            display: flex;
            gap: 1rem;
        }

        .detailed-card-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .detailed-card-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: var(--border-radius-lg);
            flex-shrink: 0;
        }

        .compact-view .detailed-card-image {
            display: none;
        }

        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-cols-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .grid-cols-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
    </style>
</head>

<body>
    <div id="loading-screen" class="loading-screen">
        <div class="sidebar-logo" style="width: 4rem; height: 4rem;"><i data-lucide="zap"
                style="width: 2rem; height: 2rem;"></i></div>
        <div class="loading-spinner"></div>
        <p>Initializing AssetFlow...</p>
    </div>
    <div id="sign-in-screen" class="sign-in-screen">
        <div class="sign-in-card">
            <div class="sidebar-logo" style="margin: 0 auto 1rem; width: 3.5rem; height: 3.5rem;"><i data-lucide="zap"
                    style="width: 1.75rem; height: 1.75rem;"></i></div>
            <h2>Welcome to AssetFlow</h2>
            <p style="color: var(--color-text-muted); margin: 0.5rem 0 1.5rem;">Please sign in to continue.</p>
            <button id="google-sign-in-btn" class="google-sign-in-btn">Sign in with Google</button>
        </div>
    </div>
    <div id="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo"><i data-lucide="zap"></i></div>
                <div class="sidebar-header-text">
                    <h1>AssetFlow</h1>
                    <p>CMMS Pro</p>
                </div>
            </div>
            <nav id="sidebar-nav"></nav>
            <div class="sidebar-footer">
                <div id="user-profile-container"></div>
            </div>
        </aside>
        <div class="main-content" id="main-content">
            <header id="main-header">
                <div class="header-left">
                    <button class="icon-button" id="sidebar-toggle-btn"><i data-lucide="menu"></i></button>
                </div>
                <div id="header-actions" class="header-right"></div>
            </header>
            <main id="main-content-area"></main>
        </div>
    </div>
    <div id="modal-container"></div>
    <div id="notification-panel" class="card"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyCxneZ380Jc7J9NnkxE7EMBhHelAWFL_3w",
                authDomain: "assetflow-cmms.firebaseapp.com",
                projectId: "assetflow-cmms",
                storageBucket: "assetflow-cmms.appspot.com"
            };
            const OWNER_EMAIL = "jonathanab76@gmail.com";
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            const storage = firebase.storage();
            const googleProvider = new firebase.auth.GoogleAuthProvider();

            emailjs.init("DCXkbqxUsfCVCNIiC");

            let currentUser = null, currentUserProfile = null;
            let activeTab = 'dashboard', currentView = 'cards';
            let firestoreListeners = [];
            let workOrdersCache = [], assetsCache = [], usersCache = [], notificationsCache = [];
            let notificationPanelOpen = false; // Track notification panel state

            const loadingScreen = document.getElementById('loading-screen');
            const signInScreen = document.getElementById('sign-in-screen');
            const appContainer = document.getElementById('app-container');
            const mainContentArea = document.getElementById('main-content-area');
            const modalContainer = document.getElementById('modal-container');
            const notificationPanel = document.getElementById('notification-panel');

            auth.onAuthStateChanged(async (user) => {
                firestoreListeners.forEach(unsubscribe => unsubscribe());
                firestoreListeners = [];
                if (user) {
                    await setupUserSession(user);
                    initializeAppUI();
                    appContainer.classList.add('ready');
                    signInScreen.classList.remove('active');
                } else {
                    currentUser = null; currentUserProfile = null;
                    appContainer.classList.remove('ready');
                    signInScreen.classList.add('active');
                }
                loadingScreen.style.display = 'none';
            });

            document.getElementById('google-sign-in-btn').addEventListener('click', () => auth.signInWithPopup(googleProvider).catch(err => console.error("Sign-in error", err)));

            async function setupUserSession(user) {
                currentUser = user;
                const userRef = db.collection('users').doc(user.uid);
                let userDoc = await userRef.get();
                if (!userDoc.exists) {
                    const inviteRef = db.collection('invites').doc(user.email);
                    const inviteDoc = await inviteRef.get();
                    let role = (user.email === OWNER_EMAIL) ? 'Owner' : (inviteDoc.exists ? inviteDoc.data().role : 'Technician');
                    const name = inviteDoc.exists && inviteDoc.data().name ? inviteDoc.data().name : user.displayName;
                    const newUserProfile = { name: name, email: user.email, photoURL: user.photoURL, role, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                    await userRef.set(newUserProfile);
                    if (inviteDoc.exists) await inviteRef.delete();
                    currentUserProfile = { id: user.uid, ...newUserProfile };
                } else {
                    currentUserProfile = { id: userDoc.id, ...userDoc.data() };
                }
            }

            const hasRole = (roles) => Array.isArray(roles) && roles.includes(currentUserProfile?.role);
            const canManageUsers = () => hasRole(['Owner', 'Admin']);
            const canManageAssets = () => hasRole(['Owner', 'Admin']);
            const canCreateWorkOrder = () => hasRole(['Owner', 'Admin']);
            const canSuggestWorkOrder = () => hasRole(['Owner', 'Admin', 'Senior Technician']);
            const canApproveWorkOrder = () => hasRole(['Owner', 'Admin']);

            function initializeAppUI() {
                renderSidebarNav();
                attachFirestoreListeners();
                const isTopLayout = localStorage.getItem('layoutTop') === 'true';
                appContainer.classList.toggle('layout-top', isTopLayout);
                renderHeaderActions();
                const isDarkMode = localStorage.getItem('darkMode') === 'true';
                applyTheme(isDarkMode);
                switchTab('dashboard');
                addGlobalEventListeners();
            }

            function attachFirestoreListeners() {
                // Work Orders listener
                firestoreListeners.push(
                    db.collection('workOrders').onSnapshot(snapshot => {
                        workOrdersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (appContainer.classList.contains('ready') && ['dashboard', 'workorders', 'reports'].includes(activeTab)) {
                            renderPage(activeTab);
                        }
                    }, err => console.error('Work orders listener error:', err))
                );

                // Assets listener
                firestoreListeners.push(
                    db.collection('assets').onSnapshot(snapshot => {
                        assetsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (appContainer.classList.contains('ready') && ['dashboard', 'assets', 'reports'].includes(activeTab)) {
                            renderPage(activeTab);
                        }
                    }, err => console.error('Assets listener error:', err))
                );

                // Users listener
                firestoreListeners.push(
                    db.collection('users').onSnapshot(snapshot => {
                        usersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (appContainer.classList.contains('ready') && ['dashboard', 'users'].includes(activeTab)) {
                            renderPage(activeTab);
                        }
                    }, err => console.error('Users listener error:', err))
                );

                // Notifications listener
                firestoreListeners.push(
                    db.collection('notifications')
                        .where('userIds', 'array-contains', currentUser.uid)
                        .orderBy('createdAt', 'desc')
                        .limit(20)
                        .onSnapshot(snapshot => {
                            notificationsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            updateNotificationBadge();
                        }, err => console.error('Notifications listener error:', err))
                );
            }

            function renderSidebarNav() {
                const sidebarItems = [
                    { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard', show: true },
                    { id: 'workorders', label: 'Work Orders', icon: 'clipboard-list', show: true },
                    { id: 'assets', label: 'Assets', icon: 'package', show: true },
                    { id: 'reports', label: 'Reports', icon: 'pie-chart', show: true },
                    { id: 'users', label: 'Users', icon: 'users', show: canManageUsers() },
                    { id: 'settings', label: 'Settings', icon: 'settings', show: true },
                ];
                document.getElementById('sidebar-nav').innerHTML = sidebarItems.filter(item => item.show).map(item => `<button class="nav-button" data-tab="${item.id}"><i data-lucide="${item.icon}"></i><span class="nav-text">${item.label}</span></button>`).join('');
                lucide.createIcons();
            }

            function getInitials(name) { return name ? name.split(' ').map(n => n[0]).join('').toUpperCase() : '?'; }

            function renderHeaderActions() {
                if (!currentUser || !currentUserProfile) return;
                document.getElementById('user-profile-container').innerHTML = `<div class="user-profile"><div class="user-avatar">${currentUser.photoURL ? `<img src="${currentUser.photoURL}" alt="Avatar">` : getInitials(currentUserProfile.name)}</div><div class="user-info"><p class="user-name">${currentUserProfile.name}</p><p class="user-role">${currentUserProfile.role}</p></div></div>`;
                const actionsHTML = `<button class="icon-button dynamic-action-item" id="theme-toggle-btn"></button> <button class="icon-button dynamic-action-item" id="notification-btn"><i data-lucide="bell"></i><span class="notification-dot"></span></button> <div class="compact-user-profile dynamic-action-item"> <div class="user-avatar">${currentUser.photoURL ? `<img src="${currentUser.photoURL}" alt="Avatar">` : getInitials(currentUserProfile.name)}</div> <div class="user-info"><p class="user-name">${currentUserProfile.name}</p></div> </div>`;
                document.querySelectorAll('.dynamic-action-item').forEach(el => el.remove());
                const isTopLayout = appContainer.classList.contains('layout-top');
                const targetContainer = isTopLayout ? document.querySelector('.sidebar-footer') : document.getElementById('header-actions');
                targetContainer.insertAdjacentHTML('beforeend', actionsHTML);
                updateThemeIcons(document.body.classList.contains('dark-mode'));
                updateNotificationBadge();
                lucide.createIcons();
            }

            function applyLayout(isTop) { appContainer.classList.toggle('layout-top', isTop); localStorage.setItem('layoutTop', isTop); renderHeaderActions(); }
            function applyTheme(isDark) { document.body.classList.toggle('dark-mode', isDark); localStorage.setItem('darkMode', isDark); updateThemeIcons(isDark); }
            function updateThemeIcons(isDark) { const themeBtn = document.querySelector('#theme-toggle-btn'); if (themeBtn) themeBtn.innerHTML = `<i data-lucide="${isDark ? 'sun' : 'moon'}"></i>`; lucide.createIcons(); }
            function updateNotificationBadge() { const unreadCount = notificationsCache.filter(n => !n.readBy || !n.readBy.includes(currentUser.uid)).length; document.querySelectorAll('.notification-dot').forEach(dot => { dot.style.display = unreadCount > 0 ? 'block' : 'none'; }); }
            function switchTab(tabId) { activeTab = tabId; document.querySelectorAll('#sidebar-nav .nav-button').forEach(btn => btn.classList.remove('active')); document.querySelector(`#sidebar-nav .nav-button[data-tab="${tabId}"]`)?.classList.add('active'); renderPage(tabId); }

            function renderPage(pageId) {
                let contentHTML = '';
                switch (pageId) {
                    case 'dashboard': contentHTML = getDashboardPageHTML(); break;
                    case 'workorders': case 'assets': case 'reports': contentHTML = getListPageHTML(pageId.charAt(0).toUpperCase() + pageId.slice(1), pageId); break;
                    case 'users': contentHTML = getUsersPageHTML(); break;
                    case 'settings': contentHTML = getSettingsPageHTML(); break;
                    default: contentHTML = `<div class="card">Page not found</div>`;
                }
                mainContentArea.innerHTML = contentHTML;
                lucide.createIcons();
                if (['workorders', 'assets', 'reports'].includes(pageId)) updateListView(pageId);
            }

            function getDashboardPageHTML() {
                const openWorkOrders = workOrdersCache.filter(w => w.status === 'Open' || w.status === 'In Progress');
                const suggestedWorkOrders = workOrdersCache.filter(w => w.status === 'Suggested');
                const myWorkOrders = workOrdersCache.filter(wo => wo.assignedToId === currentUser.uid && wo.status !== 'Completed');

                return `<div class="grid grid-cols-4"> 
                    <div class="card"><h3>Open WOs</h3><p style="font-size:2rem;font-weight:700;">${openWorkOrders.length}</p></div> 
                    <div class="card"><h3>Suggested</h3><p style="font-size:2rem;font-weight:700;">${suggestedWorkOrders.length}</p></div> 
                    <div class="card"><h3>Assets</h3><p style="font-size:2rem;font-weight:700;">${assetsCache.length}</p></div> 
                    <div class="card"><h3>Team Size</h3><p style="font-size:2rem;font-weight:700;">${usersCache.length-1}</p></div> 
                </div> 
                <div class="card" style="margin-top: 1.5rem"> 
                    <div class="card-header"><h2 class="card-title-lg">My Open Work Orders</h2></div> 
                    <div class="grid grid-cols-2">${myWorkOrders.length > 0 ? myWorkOrders.map(wo => renderDetailedCard(wo, 'workorder', 'cards')).join('') : '<p>No open work orders assigned to you.</p>'}</div> 
                </div>`;
            }

            function getListPageHTML(title, pageId) {
                const type = pageId === 'reports' ? '' : pageId.slice(0, -1);
                const canCreate = (type === 'workorder' && (canCreateWorkOrder() || canSuggestWorkOrder())) || (type === 'asset' && canManageAssets());
                const buttonText = (type === 'workorder' && !canCreateWorkOrder()) ? 'Suggest' : 'New';
                return `<div class="card">
                    <div class="card-header">
                        <h2 class="card-title-lg">${title}</h2>
                        <div class="view-controls"> 
                            ${pageId !== 'reports' && canCreate ? `<button class="btn btn-primary new-item-btn" data-type="${type}"><i data-lucide="plus"></i> ${buttonText} ${type.charAt(0).toUpperCase() + type.slice(1)}</button>` : ''} 
                            <div class="view-toggle">
                                <button data-view="cards" class="${currentView === 'cards' ? 'active' : ''}"><i data-lucide="layout-grid"></i></button>
                                <button data-view="compact" class="${currentView === 'compact' ? 'active' : ''}"><i data-lucide="rows"></i></button>
                                <button data-view="table" class="${currentView === 'table' ? 'active' : ''}"><i data-lucide="list"></i></button>
                            </div> 
                        </div>
                    </div>
                    <div class="list-view-container"></div>
                </div>`;
            }

            function getUsersPageHTML() {
                if (!canManageUsers()) return `<div class="card"><p>Access Denied.</p></div>`;
                return `<div class="card">
                    <div class="card-header">
                        <h2 class="card-title-lg">User Management</h2>
                        <button class="btn btn-primary" id="invite-user-btn"><i data-lucide="user-plus"></i> Invite User</button>
                    </div> 
                    ${usersCache.map(user => `
                        <div class="user-list-item">
                            <div style="display:flex; align-items:center; gap:1rem;">
                                <div class="user-avatar" style="width:3rem;height:3rem;">${user.photoURL ? `<img src="${user.photoURL}" alt="${user.name}">` : getInitials(user.name)}</div>
                                <div>
                                    <p style="font-weight:600; color:var(--color-text-primary);">${user.name}</p>
                                    <p style="color:var(--color-text-muted);">${user.email}</p>
                                </div>
                            </div>
                            <div style="display:flex; align-items:center; gap:1rem;">
                                <span class="tag">${user.role}</span>
                                ${user.email !== OWNER_EMAIL ? `<button class="btn btn-secondary edit-user-btn" data-id="${user.id}"><i data-lucide="edit-2" style="width:1rem"></i></button>` : ''}
                            </div>
                        </div>`).join('')}
                </div>`;
            }

            function getSettingsPageHTML() {
                return `<div class="card" style="max-width: 600px; margin: auto;">
                    <div class="card-header"><h2 class="card-title-lg">Settings</h2></div>
                    <div class="setting-item">
                        <div><p>Top Navigation</p></div>
                        <label class="switch"><input type="checkbox" id="layout-toggle" ${appContainer.classList.contains('layout-top') ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="setting-item">
                        <div><p>Dark Mode</p></div>
                        <label class="switch"><input type="checkbox" id="theme-toggle" ${document.body.classList.contains('dark-mode') ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="setting-item">
                        <p>Signed in as ${currentUser.email}</p>
                        <button id="sign-out-btn" class="btn btn-secondary">Sign Out</button>
                    </div>
                </div>`;
            }

            const getStatusClass = (status) => `status-${(status || 'open').replace(/ /g, '-').toLowerCase()}`;

            function renderDetailedCard(item, type, view) {
                if (type === 'workorder') {
                    const assignedUser = usersCache.find(u => u.id === item.assignedToId);
                    return `<div class="card clickable-card" data-id="${item.id}" data-type="workorder">
                        <div class="detailed-card-main ${view === 'compact' ? 'compact-view' : ''}">
                            ${view === 'cards' && item.imageUrl ? `<img src="${item.imageUrl}" class="detailed-card-image" alt="Work Order Image">` : ''}
                            <div class="detailed-card-content">
                                <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1rem;">
                                    <h3 style="font-weight:600; color:var(--color-text-primary);">${item.title}</h3>
                                    <span class="tag ${getStatusClass(item.status)}">${item.status}</span>
                                </div>
                                <p style="font-size:0.9rem; color: var(--color-text-muted); margin:0.5rem 0;">${item.asset || 'No Asset'}</p>
                                <div style="margin-top:auto; padding-top:1rem; border-top:1px solid var(--color-border-light); display:flex; justify-content:space-between; align-items:center; font-size:0.9rem;">
                                    <div style="display:flex; align-items:center; gap:0.5rem;">
                                        <div class="user-avatar" style="width:1.75rem; height:1.75rem; font-size:0.8rem;">${assignedUser?.photoURL ? `<img src="${assignedUser.photoURL}" alt="${assignedUser?.name}">` : getInitials(assignedUser?.name)}</div>
                                        <span>${assignedUser?.name || 'Unassigned'}</span>
                                    </div>
                                    <span>${item.dueDate || 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }
                if (type === 'asset') {
                    return `<div class="card clickable-card" data-id="${item.id}" data-type="asset">
                        <div class="detailed-card-main ${view === 'compact' ? 'compact-view' : ''}">
                            <div class="detailed-card-content">
                                <h3 style="font-weight:600; color:var(--color-text-primary);">${item.name}</h3>
                                <p style="font-size:0.9rem; color: var(--color-text-muted); margin:0.5rem 0;">${item.category}</p>
                                <div style="margin-top:1rem; font-size:0.875rem;">
                                    <span class="tag ${getStatusClass(item.status)}">${item.status}</span>
                                    <span style="margin-left:0.5rem; color:var(--color-text-muted);">$${(item.totalPrice || 0).toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }
            }

            function renderTable(data, type) {
                if (type === 'workorder') {
                    const headers = ['Title', 'Status', 'Assigned To', 'Due Date'];
                    return `<table class="data-table">
                        <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                        <tbody>${data.map(item => {
                        const user = usersCache.find(u => u.id === item.assignedToId);
                        return `<tr data-id="${item.id}" data-type="workorder">
                                <td>${item.title}</td>
                                <td><span class="tag ${getStatusClass(item.status)}">${item.status}</span></td>
                                <td>${user?.name || 'Unassigned'}</td>
                                <td>${item.dueDate || 'N/A'}</td>
                            </tr>`
                    }).join('')}</tbody>
                    </table>`;
                }
                if (type === 'asset') {
                    const headers = ['Name', 'Category', 'Status', 'Price'];
                    return `<table class="data-table">
                        <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                        <tbody>${data.map(item => `<tr data-id="${item.id}" data-type="asset">
                            <td>${item.name}</td>
                            <td>${item.category}</td>
                            <td><span class="tag ${getStatusClass(item.status)}">${item.status}</span></td>
                            <td>$${(item.totalPrice || 0).toLocaleString()}</td>
                        </tr>`).join('')}</tbody>
                    </table>`;
                }
            }

            function updateListView(pageId) {
                const container = mainContentArea.querySelector('.list-view-container');
                if (!container) return;

                const dataMap = {
                    workorders: workOrdersCache,
                    assets: assetsCache,
                    reports: { workOrders: workOrdersCache, assets: assetsCache }
                };
                const data = dataMap[pageId];
                const type = pageId === 'reports' ? null : pageId.slice(0, -1);
                const gridClass = currentView === 'compact' ? 'grid-cols-1' : 'grid-cols-2';

                if (currentView === 'table') {
                    if (pageId === 'reports') {
                        container.innerHTML = `
                            <h4>Work Orders</h4>
                            ${renderTable(data.workOrders, 'workorder')} 
                            <h4 style="margin-top:2rem">Assets</h4>
                            ${renderTable(data.assets, 'asset')}`;
                    } else {
                        container.innerHTML = renderTable(data, type);
                    }
                } else {
                    if (pageId === 'reports') {
                        container.innerHTML = `
                            <h4>Work Orders</h4>
                            <div class="grid ${gridClass}">${data.workOrders.map(item => renderDetailedCard(item, 'workorder', currentView)).join('')}</div> 
                            <h4 style="margin-top:2rem">Assets</h4>
                            <div class="grid ${gridClass}">${data.assets.map(item => renderDetailedCard(item, 'asset', currentView)).join('')}</div>`;
                    } else {
                        container.innerHTML = `<div class="grid ${gridClass}">${data.map(item => renderDetailedCard(item, type, currentView)).join('')}</div>`;
                    }
                }
                lucide.createIcons();
            }

            function addGlobalEventListeners() {
                // Main app container click handler
                appContainer.addEventListener('click', async e => {
                    e.stopPropagation();

                    const navBtn = e.target.closest('.nav-button');
                    if (navBtn) return switchTab(navBtn.dataset.tab);

                    const card = e.target.closest('.clickable-card, .data-table tr[data-id]');
                    if (card) {
                        const type = card.dataset.type, id = card.dataset.id;
                        if (type === 'workorder') return getWorkOrderModal(id);
                        if (type === 'asset') return getAssetModal(id);
                    }

                    const newItemBtn = e.target.closest('.new-item-btn');
                    if (newItemBtn) {
                        const type = newItemBtn.dataset.type;
                        if (type === 'workorder') return getWorkOrderModal(null);
                        if (type === 'asset') return getAssetModal(null);
                    }

                    const viewBtn = e.target.closest('.view-toggle button');
                    if (viewBtn) {
                        currentView = viewBtn.dataset.view;
                        return renderPage(activeTab);
                    }

                    const inviteUserBtn = e.target.closest('#invite-user-btn');
                    if (inviteUserBtn) return getInviteUserModal();

                    const editUserBtn = e.target.closest('.edit-user-btn');
                    if (editUserBtn) return getEditUserModal(editUserBtn.dataset.id);

                    const signOutBtn = e.target.closest('#sign-out-btn');
                    if (signOutBtn) return auth.signOut();

                    const layoutToggle = e.target.closest('#layout-toggle');
                    if (layoutToggle) return applyLayout(layoutToggle.checked);

                    const themeToggle = e.target.closest('#theme-toggle');
                    if (themeToggle) return applyTheme(themeToggle.checked);

                    const sidebarToggleBtn = e.target.closest('#sidebar-toggle-btn');
                    if (sidebarToggleBtn) {
                        document.getElementById('sidebar').classList.toggle('collapsed');
                        document.getElementById('main-content').classList.toggle('sidebar-collapsed');
                    }

                    // Fixed notification button handler
                    const notificationBtn = e.target.closest('#notification-btn');
                    if (notificationBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        toggleNotificationPanel();
                        return;
                    }

                    const headerThemeToggleBtn = e.target.closest('#theme-toggle-btn');
                    if (headerThemeToggleBtn) return applyTheme(!document.body.classList.contains('dark-mode'));
                });

                // Modal container click handler
                modalContainer.addEventListener('click', e => {
                    if (e.target.closest('.modal-close-btn') || e.target.classList.contains('modal-backdrop')) {
                        modalContainer.innerHTML = '';
                    }
                });

                // Document click handler for closing notification panel
                document.addEventListener('click', e => {
                    if (notificationPanelOpen && !notificationPanel.contains(e.target) && !e.target.closest('#notification-btn')) {
                        notificationPanel.style.display = 'none';
                        notificationPanelOpen = false;
                    }
                });
            }

            async function sendEmailNotification(templateId, templateParams, recipientEmail) {
                console.log(`--- EMAIL SIMULATION --- To: ${recipientEmail}, Template ID: ${templateId}, Params:`, templateParams);

                try {
                    await emailjs.send('service_1d3qyue', templateId, {
                        ...templateParams,
                        to_email: recipientEmail
                    });
                    console.log('Email sent successfully');
                } catch (error) {
                    console.error('Email send failed:', error);
                }
            }

            async function createNotification({ userIds, title, text, icon = 'info', link = {} }) {
                if (!userIds || userIds.length === 0) return;
                await db.collection('notifications').add({
                    userIds, title, text, icon, link, readBy: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            // Fixed notification panel toggle
            async function toggleNotificationPanel() {
                if (notificationPanelOpen) {
                    notificationPanel.style.display = 'none';
                    notificationPanelOpen = false;
                } else {
                    // Mark unread notifications as read
                    const unreadNotifs = notificationsCache.filter(n => !n.readBy || !n.readBy.includes(currentUser.uid));
                    if (unreadNotifs.length > 0) {
                        const batch = db.batch();
                        unreadNotifs.forEach(n => {
                            batch.update(db.collection('notifications').doc(n.id), {
                                readBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                            });
                        });
                        await batch.commit();
                    }

                    // Render notification panel content
                    notificationPanel.innerHTML = `
                        <div class="card-header">
                            <h3 class="card-title-lg">Notifications</h3>
                        </div>
                        <div id="notification-list" style="padding: 0 1.5rem 1.5rem;"> 
                            ${notificationsCache.length > 0 ? notificationsCache.map(n => ` 
                                <div class="notification-item">
                                    <div><i data-lucide="${n.icon}"></i></div>
                                    <div>
                                        <p style="font-weight:600; color:var(--color-text-primary);">${n.title}</p>
                                        <p>${n.text}</p>
                                    </div>
                                </div> 
                            `).join('') : '<p style="padding: 1rem 0; color: var(--color-text-muted);">No notifications yet.</p>'} 
                        </div>`;

                    // Position the panel
                    const notificationBtn = document.querySelector('#notification-btn');
                    if (notificationBtn) {
                        const rect = notificationBtn.getBoundingClientRect();
                        notificationPanel.style.top = `${rect.bottom + 10}px`;
                        notificationPanel.style.right = `${window.innerWidth - rect.right}px`;
                    }

                    notificationPanel.style.display = 'block';
                    notificationPanelOpen = true;
                    lucide.createIcons();
                }
            }

            async function getWorkOrderModal(woId) {
                const isNew = !woId;
                const woDoc = isNew ? null : await db.collection('workOrders').doc(woId).get();
                const wo = isNew ? {} : woDoc.data();
                let canEdit = isNew || canApproveWorkOrder() || wo.assignedToId === currentUser.uid;

                modalContainer.innerHTML = `<div class="modal-backdrop active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">${isNew ? 'New' : 'Edit'} Work Order</h2>
                            <button type="button" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="wo-form" class="modal-body">
                            <div class="image-preview-container">
                                <img id="wo-image-preview" src="${wo.imageUrl || ''}" alt="Work Order Image Preview">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Title</label>
                                <input class="form-input" name="title" value="${wo.title || ''}" ${!canEdit ? 'disabled' : ''} required>
                            </div>
                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">Asset</label>
                                    <input class="form-input" name="asset" value="${wo.asset || ''}" ${!canEdit ? 'disabled' : ''}>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Price ($)</label>
                                    <input type="number" class="form-input" name="price" value="${wo.price || 0}" ${!canEdit ? 'disabled' : ''}>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Assigned To</label>
                                    <select class="form-select" name="assignedToId" ${!canEdit ? 'disabled' : ''}>
                                        <option value="">Unassigned</option>
                                        ${usersCache.map(u => `<option value="${u.id}" ${u.id === wo.assignedToId ? 'selected' : ''}>${u.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" name="status" ${!canApproveWorkOrder() ? 'disabled' : ''}>
                                        ${['Open', 'In Progress', 'Completed', 'Suggested'].map(s => `<option value="${s}" ${s === (wo.status || (canCreateWorkOrder() ? 'Open' : 'Suggested')) ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Due Date</label>
                                    <input type="date" class="form-input" name="dueDate" value="${wo.dueDate || ''}" ${!canEdit ? 'disabled' : ''}>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Work Order Image</label>
                                    <input type="file" class="form-input" name="imageUpload" accept="image/*" ${!canEdit ? 'disabled' : ''}>
                                </div>
                            </div>
                        </form>
                        <div class="modal-footer" id="wo-modal-footer"></div>
                    </div>
                </div>`;

                // Image preview handler
                const imageInput = document.querySelector('input[name="imageUpload"]');
                const imagePreview = document.getElementById('wo-image-preview');
                imageInput.addEventListener('change', () => {
                    if (imageInput.files[0]) {
                        imagePreview.src = URL.createObjectURL(imageInput.files[0]);
                        imagePreview.style.display = 'block';
                    }
                });

                const footer = document.getElementById('wo-modal-footer');
                let footerHTML = `<button type="button" class="btn btn-secondary modal-close-btn">Cancel</button>`;
                if (wo.status === 'Suggested' && canApproveWorkOrder()) {
                    footerHTML += `<button type="button" class="btn btn-danger" data-action="reject">Reject</button>
                                   <button type="button" class="btn btn-primary" data-action="approve">Approve</button>`;
                } else if (canEdit) {
                    footerHTML += `<button type="button" class="btn btn-primary" data-action="save">Save</button>`;
                }
                footer.innerHTML = footerHTML;

                footer.addEventListener('click', async e => {
                    const action = e.target.dataset.action;
                    if (!action) return;

                    const form = document.getElementById('wo-form');
                    const data = {
                        title: form.title.value,
                        asset: form.asset.value,
                        price: Number(form.price.value),
                        assignedToId: form.assignedToId.value,
                        status: form.status.value,
                        dueDate: form.dueDate.value,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: currentUser.uid
                    };

                    if (action === 'save') {
                        try {
                            const imageFile = form.imageUpload.files[0];
                            const docRef = isNew ? db.collection('workOrders').doc() : db.collection('workOrders').doc(woId);

                            // Handle image upload
                            if (imageFile) {
                                const storageRef = storage.ref(`work-orders/${docRef.id}/${Date.now()}_${imageFile.name}`);
                                const uploadTask = await storageRef.put(imageFile);
                                data.imageUrl = await uploadTask.ref.getDownloadURL();
                            } else if (!isNew && wo.imageUrl) {
                                // Keep existing image if no new image uploaded
                                data.imageUrl = wo.imageUrl;
                            }

                            if (isNew) {
                                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                                data.createdBy = currentUser.uid;
                                if (!canCreateWorkOrder()) data.status = 'Suggested';
                                await docRef.set(data);
                            } else {
                                await docRef.update(data);
                            }

                            // Handle notifications
                            const assignedUser = usersCache.find(u => u.id === data.assignedToId);
                            const adminsAndOwners = usersCache.filter(u => hasRole.call({ currentUserProfile: u }, ['Owner', 'Admin']));

                            if (isNew) {
                                if (data.status === 'Suggested') {
                                    createNotification({
                                        userIds: adminsAndOwners.map(u => u.id),
                                        title: "New WO Suggestion",
                                        text: `"${data.title}" was suggested by ${currentUserProfile.name}.`,
                                        icon: 'lightbulb'
                                    });
                                } else if (assignedUser) {
                                    createNotification({
                                        userIds: [assignedUser.id],
                                        title: "New Assignment",
                                        text: `You were assigned to "${data.title}".`,
                                        icon: 'clipboard-list'
                                    });
                                }
                            } else {
                                if (data.assignedToId && data.assignedToId !== wo.assignedToId) {
                                    createNotification({
                                        userIds: [data.assignedToId],
                                        title: "New Assignment",
                                        text: `You were assigned to "${data.title}".`,
                                        icon: 'clipboard-list'
                                    });
                                    if (wo.assignedToId) {
                                        createNotification({
                                            userIds: [wo.assignedToId],
                                            title: "Work Order Re-assigned",
                                            text: `"${data.title}" is no longer assigned to you.`,
                                            icon: 'user-x'
                                        });
                                    }
                                }
                                if (wo.status !== 'Completed' && data.status === 'Completed') {
                                    createNotification({
                                        userIds: adminsAndOwners.map(u => u.id),
                                        title: "Work Order Completed",
                                        text: `"${data.title}" was completed by ${assignedUser?.name || 'N/A'}.`
                                    });
                                }
                            }

                            modalContainer.innerHTML = ''; // Close modal
                        } catch (error) {
                            console.error('Error saving work order:', error);
                            alert('Error saving work order. Please try again.');
                        }
                    } else if (action === 'approve') {
                        await db.collection('workOrders').doc(woId).update({
                            status: 'Open',
                            approvedBy: currentUser.uid,
                            approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        modalContainer.innerHTML = '';
                    } else if (action === 'reject' && confirm('Reject and delete this suggestion?')) {
                        await db.collection('workOrders').doc(woId).delete();
                        modalContainer.innerHTML = '';
                    }
                });
            }

            async function getAssetModal(assetId) {
                const isNew = !assetId;
                const assetDoc = isNew ? null : await db.collection('assets').doc(assetId).get();
                const asset = isNew ? {} : assetDoc.data();

                modalContainer.innerHTML = `<div class="modal-backdrop active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">${isNew ? 'New' : 'Edit'} Asset</h2>
                            <button type="button" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="asset-form" class="modal-body">
                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">Asset Name</label>
                                    <input class="form-input" name="name" value="${asset.name || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <input class="form-input" name="category" value="${asset.category || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" name="status">
                                        <option ${asset.status === 'Operational' ? 'selected' : ''}>Operational</option>
                                        <option ${asset.status === 'Needs Attention' ? 'selected' : ''}>Needs Attention</option>
                                        <option ${asset.status === 'Out of Service' ? 'selected' : ''}>Out of Service</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Price ($)</label>
                                    <input type="number" class="form-input" name="totalPrice" value="${asset.totalPrice || 0}">
                                </div>
                            </div>
                        </form>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary modal-close-btn">Cancel</button>
                            <button type="button" class="btn btn-primary" id="save-asset-btn">Save Asset</button>
                        </div>
                    </div>
                </div>`;

                document.getElementById('save-asset-btn').addEventListener('click', async () => {
                    try {
                        const form = document.getElementById('asset-form');
                        const data = {
                            name: form.name.value,
                            category: form.category.value,
                            status: form.status.value,
                            totalPrice: Number(form.totalPrice.value),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        if (isNew) {
                            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                            await db.collection('assets').add(data);
                        } else {
                            await db.collection('assets').doc(assetId).update(data);
                        }

                        modalContainer.innerHTML = ''; // Close modal
                    } catch (error) {
                        console.error('Error saving asset:', error);
                        alert('Error saving asset. Please try again.');
                    }
                });
            }

            function getInviteUserModal() {
                modalContainer.innerHTML = `<div class="modal-backdrop active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Invite New User</h2>
                            <button type="button" class="modal-close-btn">&times;</button>
                        </div>
                        <div class="modal-body"> 
                            <div class="form-group">
                                <label class="form-label">User's Full Name</label>
                                <input class="form-input" type="text" id="invite-name" placeholder="Jane Doe" required>
                            </div> 
                            <div class="form-group">
                                <label class="form-label">User Email</label>
                                <input class="form-input" type="email" id="invite-email" placeholder="user@company.com" required>
                            </div> 
                            <div class="form-group">
                                <label class="form-label">Role</label>
                                <select class="form-select" id="invite-role">
                                    ${['Technician', 'Senior Technician', 'Admin'].map(r => `<option>${r}</option>`).join('')}
                                </select>
                            </div> 
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary modal-close-btn">Cancel</button>
                            <button type="button" class="btn btn-primary" id="send-invite-btn">Send Invite</button>
                        </div>
                    </div>
                </div>`;

                document.getElementById('send-invite-btn').addEventListener('click', async () => {
                    try {
                        const name = document.getElementById('invite-name').value.trim();
                        const email = document.getElementById('invite-email').value.trim().toLowerCase();
                        const role = document.getElementById('invite-role').value;

                        if (!email || !name) {
                            alert('Name and email are required.');
                            return;
                        }

                        await db.collection('invites').doc(email).set({
                            name,
                            role,
                            invitedBy: currentUser.uid,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        alert(`Invite sent to ${email}.`);
                        modalContainer.innerHTML = '';
                    } catch (error) {
                        console.error('Error sending invite:', error);
                        alert('Error sending invite. Please try again.');
                    }
                });
            }

            function getEditUserModal(userId) {
                const user = usersCache.find(u => u.id === userId);
                if (!user) return;

                modalContainer.innerHTML = `<div class="modal-backdrop active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Edit Role for ${user.name}</h2>
                            <button type="button" class="modal-close-btn">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Role</label>
                                <select id="user-role-select" class="form-select">
                                    ${['Technician', 'Senior Technician', 'Admin'].map(r => `<option value="${r}" ${r === user.role ? 'selected' : ''}>${r}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary modal-close-btn">Cancel</button>
                            <button type="button" id="save-role-btn" class="btn btn-primary">Save Role</button>
                        </div>
                    </div>
                </div>`;

                document.getElementById('save-role-btn').addEventListener('click', async () => {
                    try {
                        await db.collection('users').doc(userId).update({
                            role: document.getElementById('user-role-select').value
                        });
                        modalContainer.innerHTML = '';
                    } catch (error) {
                        console.error('Error updating user role:', error);
                        alert('Error updating user role. Please try again.');
                    }
                });
            }
        });
    </script>
</body>

</html>
